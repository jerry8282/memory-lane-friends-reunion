
import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { ArrowLeft, Heart, User, Mail, Lock, Calendar } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { useToast } from '@/hooks/use-toast';

interface RegisterScreenProps {
  onBack: () => void;
}

const RegisterScreen: React.FC<RegisterScreenProps> = ({ onBack }) => {
  const [step, setStep] = useState<1 | 2 | 3>(1);
  const [isLoading, setIsLoading] = useState(false);
  const { register } = useAuth();
  const { toast } = useToast();

  // Step 1: Í∏∞Î≥∏ Ï†ïÎ≥¥
  const [basicInfo, setBasicInfo] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    name: '',
    nickname: '',
    birthYear: '',
    gender: '' as 'male' | 'female' | ''
  });

  // Step 2: Í≥ºÍ±∞ Í∏∞Ïñµ Ï†ïÎ≥¥
  const [memoryInfo, setMemoryInfo] = useState({
    rememberedYears: {
      startYear: '',
      endYear: '',
      timeDescription: ''
    },
    rememberedLocation: '',
    schoolOrWork: '',
    oldNickname: ''
  });

  // Step 3: Í∞úÏù∏Ï†ïÎ≥¥ ÎèôÏùò
  const [agreements, setAgreements] = useState({
    privacy: false,
    location: false,
    realName: false
  });

  const handleStep1Submit = (e: React.FormEvent) => {
    e.preventDefault();
    if (basicInfo.password !== basicInfo.confirmPassword) {
      toast({
        title: "ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏",
        description: "ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.",
        variant: "destructive"
      });
      return;
    }
    setStep(2);
  };

  const handleStep2Submit = (e: React.FormEvent) => {
    e.preventDefault();
    setStep(3);
  };

  const handleFinalSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!agreements.privacy) {
      toast({
        title: "ÌïÑÏàò ÎèôÏùò",
        description: "Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è ÌôúÏö©Ïóê ÎèôÏùòÌï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive"
      });
      return;
    }

    setIsLoading(true);
    
    try {
      const userData: any = {
        email: basicInfo.email,
        password: basicInfo.password,
        nickname: basicInfo.nickname,
        name: basicInfo.name,
        birthYear: parseInt(basicInfo.birthYear),
        profile: {
          rememberedYears: {
            startYear: parseInt(memoryInfo.rememberedYears.startYear),
            endYear: parseInt(memoryInfo.rememberedYears.endYear),
            timeDescription: memoryInfo.rememberedYears.timeDescription
          },
          rememberedLocation: memoryInfo.rememberedLocation,
          schoolOrWork: memoryInfo.schoolOrWork,
          oldNickname: memoryInfo.oldNickname,
          memorablePlaces: [],
          activityKeywords: []
        }
      };

      // Only include gender if it's selected
      if (basicInfo.gender && (basicInfo.gender === 'male' || basicInfo.gender === 'female')) {
        userData.gender = basicInfo.gender;
      }

      const success = await register(userData);
      if (success) {
        toast({
          title: "ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å! üéâ",
          description: "Í∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! ÎãπÏã†Ïùò Ï∂îÏñµÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ëÏù¥ÏóêÏöî...",
        });
        
        // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        setTimeout(() => {
          onBack(); // Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        }, 200); // ÏßßÏùÄ ÏßÄÏó∞ÏúºÎ°ú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Î≥¥Ïû•
      } else {
        toast({
          title: "ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®",
          description: "ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
          variant: "destructive"
        });
      }
    } catch (error) {
      toast({
        title: "Ïò§Î•ò Î∞úÏÉù",
        description: "ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
        variant: "destructive"
      });
    } finally {
      setIsLoading(false);
    }
  };

  const renderStep1 = () => (
    <Card className="border-purple-100 shadow-lg">
      <CardHeader className="text-center pb-4">
        <CardTitle className="text-lg text-gray-800">Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</CardTitle>
        <p className="text-sm text-gray-600">Step 1 of 3</p>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleStep1Submit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email" className="text-sm font-medium text-gray-700">
              Ïù¥Î©îÏùº <span className="text-red-500">*</span>
            </Label>
            <div className="relative">
              <Mail className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
              <Input
                id="email"
                type="email"
                value={basicInfo.email}
                onChange={(e) => setBasicInfo({...basicInfo, email: e.target.value})}
                placeholder="Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                className="pl-10"
                required
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="password" className="text-sm font-medium text-gray-700">
              ÎπÑÎ∞ÄÎ≤àÌò∏ <span className="text-red-500">*</span>
            </Label>
            <div className="relative">
              <Lock className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
              <Input
                id="password"
                type="password"
                value={basicInfo.password}
                onChange={(e) => setBasicInfo({...basicInfo, password: e.target.value})}
                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                className="pl-10"
                required
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="confirmPassword" className="text-sm font-medium text-gray-700">
              ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ <span className="text-red-500">*</span>
            </Label>
            <div className="relative">
              <Lock className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
              <Input
                id="confirmPassword"
                type="password"
                value={basicInfo.confirmPassword}
                onChange={(e) => setBasicInfo({...basicInfo, confirmPassword: e.target.value})}
                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                className="pl-10"
                required
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="name" className="text-sm font-medium text-gray-700">
                Ïù¥Î¶Ñ <span className="text-red-500">*</span>
              </Label>
              <div className="relative">
                <User className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
                <Input
                  id="name"
                  value={basicInfo.name}
                  onChange={(e) => setBasicInfo({...basicInfo, name: e.target.value})}
                  placeholder="Ïã§Î™Ö"
                  className="pl-10"
                  required
                />
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="nickname" className="text-sm font-medium text-gray-700">
                ÎãâÎÑ§ÏûÑ <span className="text-red-500">*</span>
              </Label>
              <Input
                id="nickname"
                value={basicInfo.nickname}
                onChange={(e) => setBasicInfo({...basicInfo, nickname: e.target.value})}
                placeholder="ÎãâÎÑ§ÏûÑ"
                required
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="birthYear" className="text-sm font-medium text-gray-700">
                Ï∂úÏÉùÎÖÑÎèÑ <span className="text-red-500">*</span>
              </Label>
              <div className="relative">
                <Calendar className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
                <Input
                  id="birthYear"
                  type="number"
                  value={basicInfo.birthYear}
                  onChange={(e) => setBasicInfo({...basicInfo, birthYear: e.target.value})}
                  placeholder="1995"
                  className="pl-10"
                  min="1950"
                  max="2010"
                  required
                />
              </div>
            </div>

            <div className="space-y-2">
              <Label className="text-sm font-medium text-gray-700">ÏÑ±Î≥Ñ</Label>
              <div className="flex gap-2">
                <Button
                  type="button"
                  variant={basicInfo.gender === 'male' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setBasicInfo({...basicInfo, gender: 'male'})}
                  className="flex-1"
                >
                  ÎÇ®ÏÑ±
                </Button>
                <Button
                  type="button"
                  variant={basicInfo.gender === 'female' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setBasicInfo({...basicInfo, gender: 'female'})}
                  className="flex-1"
                >
                  Ïó¨ÏÑ±
                </Button>
              </div>
            </div>
          </div>

          <Button
            type="submit"
            className="w-full h-12 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all"
          >
            Îã§Ïùå Îã®Í≥ÑÎ°ú ‚û°Ô∏è
          </Button>
        </form>
      </CardContent>
    </Card>
  );

  const renderStep2 = () => (
    <Card className="border-purple-100 shadow-lg">
      <CardHeader className="text-center pb-4">
        <CardTitle className="text-lg text-gray-800">Í≥ºÍ±∞Ïùò Í∏∞ÏñµÏùÑ ÏïåÎ†§Ï£ºÏÑ∏Ïöî</CardTitle>
        <p className="text-sm text-gray-600">Step 2 of 3 ‚Ä¢ ÏπúÍµ¨Î•º Ï∞æÎäîÎç∞ ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§</p>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleStep2Submit} className="space-y-4">
          <div className="space-y-2">
            <Label className="text-sm font-medium text-gray-700">
              ÏπúÌñàÎçò ÏãúÍ∏∞ <span className="text-red-500">*</span>
            </Label>
            <div className="grid grid-cols-2 gap-2">
              <Input
                type="number"
                value={memoryInfo.rememberedYears.startYear}
                onChange={(e) => setMemoryInfo({
                  ...memoryInfo,
                  rememberedYears: { ...memoryInfo.rememberedYears, startYear: e.target.value }
                })}
                placeholder="2010"
                min="1990"
                max="2024"
                required
              />
              <Input
                type="number"
                value={memoryInfo.rememberedYears.endYear}
                onChange={(e) => setMemoryInfo({
                  ...memoryInfo,
                  rememberedYears: { ...memoryInfo.rememberedYears, endYear: e.target.value }
                })}
                placeholder="2013"
                min="1990"
                max="2024"
                required
              />
            </div>
            <Input
              value={memoryInfo.rememberedYears.timeDescription}
              onChange={(e) => setMemoryInfo({
                ...memoryInfo,
                rememberedYears: { ...memoryInfo.rememberedYears, timeDescription: e.target.value }
              })}
              placeholder="Ïòà: Í≥†Îì±ÌïôÏÉù Îïå, ÎåÄÌïôÍµê 1ÌïôÎÖÑ Îïå"
              required
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="location" className="text-sm font-medium text-gray-700">
              ÎãπÏãú ÌôúÎèô ÏßÄÏó≠ <span className="text-red-500">*</span>
            </Label>
            <Textarea
              id="location"
              value={memoryInfo.rememberedLocation}
              onChange={(e) => setMemoryInfo({...memoryInfo, rememberedLocation: e.target.value})}
              placeholder="Ïòà: ÏÑúÏö∏Ïãú ÏÜ°ÌååÍµ¨ Ïû†Ïã§Îèô, Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄÍµ¨"
              required
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="school" className="text-sm font-medium text-gray-700">
              ÌïôÍµê ÎòêÎäî ÏßÅÏû•Î™Ö
            </Label>
            <Input
              id="school"
              value={memoryInfo.schoolOrWork}
              onChange={(e) => setMemoryInfo({...memoryInfo, schoolOrWork: e.target.value})}
              placeholder="Ïòà: Ïû†Ïã§Í≥†Îì±ÌïôÍµê, ÏÇºÏÑ±Ï†ÑÏûê"
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="oldNickname" className="text-sm font-medium text-gray-700">
              ÎãπÏãú Î≥ÑÎ™ÖÏù¥ÎÇò ID
            </Label>
            <Input
              id="oldNickname"
              value={memoryInfo.oldNickname}
              onChange={(e) => setMemoryInfo({...memoryInfo, oldNickname: e.target.value})}
              placeholder="Ïòà: ÏûëÏùÄ ÎπõÎÇòÎ¶¨, ÏΩîÎî©Ïôï"
            />
          </div>

          <div className="flex gap-3">
            <Button
              type="button"
              variant="outline"
              onClick={() => setStep(1)}
              className="flex-1"
            >
              Ïù¥Ï†Ñ
            </Button>
            <Button
              type="submit"
              className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold"
            >
              Îã§Ïùå Îã®Í≥ÑÎ°ú ‚û°Ô∏è
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );

  const renderStep3 = () => (
    <Card className="border-purple-100 shadow-lg">
      <CardHeader className="text-center pb-4">
        <CardTitle className="text-lg text-gray-800">ÏïΩÍ¥Ä ÎèôÏùò</CardTitle>
        <p className="text-sm text-gray-600">Step 3 of 3 ‚Ä¢ ÎßàÏßÄÎßâ Îã®Í≥ÑÏûÖÎãàÎã§</p>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleFinalSubmit} className="space-y-4">
          <div className="space-y-4">
            <div className="flex items-start space-x-3 p-4 bg-purple-50 rounded-lg">
              <input
                type="checkbox"
                id="privacy"
                checked={agreements.privacy}
                onChange={(e) => setAgreements({...agreements, privacy: e.target.checked})}
                className="mt-1"
                required
              />
              <div>
                <Label htmlFor="privacy" className="text-sm font-medium text-gray-700">
                  Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è ÌôúÏö© ÎèôÏùò <span className="text-red-500">*</span>
                </Label>
                <p className="text-xs text-gray-600 mt-1">
                  ÏÑúÎπÑÏä§ Ï†úÍ≥µÏùÑ ÏúÑÌïú ÏµúÏÜåÌïúÏùò Í∞úÏù∏Ï†ïÎ≥¥Î•º ÏàòÏßëÌï©ÎãàÎã§.
                </p>
              </div>
            </div>

            <div className="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
              <input
                type="checkbox"
                id="location"
                checked={agreements.location}
                onChange={(e) => setAgreements({...agreements, location: e.target.checked})}
                className="mt-1"
              />
              <div>
                <Label htmlFor="location" className="text-sm font-medium text-gray-700">
                  ÏúÑÏπò Ï†ïÎ≥¥ ÌôúÏö© ÎèôÏùò (ÏÑ†ÌÉù)
                </Label>
                <p className="text-xs text-gray-600 mt-1">
                  Îçî Ï†ïÌôïÌïú ÏπúÍµ¨ Îß§Ïπ≠ÏùÑ ÏúÑÌï¥ ÏúÑÏπò Ï†ïÎ≥¥Î•º ÌôúÏö©Ìï©ÎãàÎã§.
                </p>
              </div>
            </div>

            <div className="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
              <input
                type="checkbox"
                id="realName"
                checked={agreements.realName}
                onChange={(e) => setAgreements({...agreements, realName: e.target.checked})}
                className="mt-1"
              />
              <div>
                <Label htmlFor="realName" className="text-sm font-medium text-gray-700">
                  Ïã§Î™Ö Ïù∏Ï¶ù (ÏÑ†ÌÉù)
                </Label>
                <p className="text-xs text-gray-600 mt-1">
                  Îçî Ïã†Î¢∞Ìï† Ïàò ÏûàÎäî ÎßåÎÇ®ÏùÑ ÏúÑÌïú ÏÑ†ÌÉùÏÇ¨Ìï≠ÏûÖÎãàÎã§.
                </p>
              </div>
            </div>
          </div>

          <div className="bg-blue-50 p-4 rounded-lg">
            <p className="text-xs text-blue-700">
              üí° Î™®Îì† Ï†ïÎ≥¥Îäî ÏÇ¨Ïö©ÏûêÏùò ÎèôÏùò ÏóÜÏù¥ Í≥µÍ∞úÎêòÏßÄ ÏïäÏúºÎ©∞, Ï±ÑÌåÖ ÏàòÎùΩ Ï†ÑÍπåÏßÄ ÏÉÅÎåÄÎ∞©ÏóêÍ≤å ÎÖ∏Ï∂úÎêòÏßÄ ÏïäÏäµÎãàÎã§.
            </p>
          </div>

          <div className="flex gap-3">
            <Button
              type="button"
              variant="outline"
              onClick={() => setStep(2)}
              className="flex-1"
            >
              Ïù¥Ï†Ñ
            </Button>
            <Button
              type="submit"
              disabled={isLoading}
              className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold"
            >
              {isLoading ? 'Í∞ÄÏûÖ Ï§ë...' : 'ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å üå∏'}
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );

  return (
    <div className="space-y-6 pt-6">
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <Button variant="ghost" size="sm" onClick={step === 1 ? onBack : () => setStep(step - 1 as 1 | 2)}>
          <ArrowLeft className="w-4 h-4" />
        </Button>
        <div className="flex items-center gap-2">
          <Heart className="w-5 h-5 text-purple-500" />
          <h2 className="text-xl font-bold text-gray-800">ÌöåÏõêÍ∞ÄÏûÖ</h2>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="flex items-center gap-2 mb-6">
        {[1, 2, 3].map((i) => (
          <div
            key={i}
            className={`flex-1 h-2 rounded-full ${
              i <= step ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gray-200'
            }`}
          />
        ))}
      </div>

      {step === 1 && renderStep1()}
      {step === 2 && renderStep2()}
      {step === 3 && renderStep3()}
    </div>
  );
};

export default RegisterScreen;
